// Generate articles for each category using OpenRouter
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');
const axios = require('axios');

const supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
);

const OPENROUTER_API_KEY = process.env.OPENAI_API_KEY;
const OPENROUTER_BASE_URL = process.env.OPENAI_BASE_URL || 'https://openrouter.ai/api/v1';

// Article topics for each category
const articleTopics = {
    1: [ // Technology
        'The Future of Artificial Intelligence in 2025',
        'Quantum Computing: Breaking New Boundaries'
    ],
    2: [ // Business
        'Top Business Strategies for Startup Success',
        'E-commerce Trends Reshaping Retail Industry'
    ],
    3: [ // Science
        'Breakthrough in Renewable Energy Research',
        'Space Exploration: Mars Mission Updates'
    ],
    4: [ // Health
        'Revolutionary Health Tech Innovations',
        'Mental Health Awareness in Modern Society'
    ],
    5: [ // Politics
        'Global Climate Policy Changes 2025',
        'Digital Democracy and Voting Systems'
    ]
};

async function generateArticleContent(topic, categoryName) {
    try {
        console.log(`ü§ñ Generating content for: "${topic}"...`);
        
        const response = await axios.post(
            `${OPENROUTER_BASE_URL}/chat/completions`,
            {
                model: 'openai/gpt-4o-mini',
                messages: [
                    {
                        role: 'system',
                        content: 'You are a professional blog writer. Write engaging, well-structured articles in HTML format with proper headings (h2, h3), paragraphs, and lists.'
                    },
                    {
                        role: 'user',
                        content: `Write a comprehensive blog article about: "${topic}" in the ${categoryName} category. 
                        
                        Requirements:
                        - 600-800 words
                        - Include an engaging introduction
                        - Use proper HTML structure with <h2>, <h3>, <p>, <ul>, <li> tags
                        - Wrap everything in <div class="post-content">
                        - Make it informative and SEO-friendly
                        - Include 3-4 main sections with subheadings
                        - Add a conclusion
                        
                        Format: Return ONLY the HTML content, no markdown.`
                    }
                ],
                max_tokens: 2000,
                temperature: 0.7
            },
            {
                headers: {
                    'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': 'http://localhost:3000',
                    'X-Title': 'AI Blog Generator'
                }
            }
        );
        
        return response.data.choices[0].message.content;
    } catch (error) {
        console.error('‚ùå Error generating content:', error.response?.data || error.message);
        return `<div class="post-content"><h2>${topic}</h2><p>This is a sample article about ${topic}. The content would normally be generated by AI.</p></div>`;
    }
}

function generateSlug(title) {
    return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        + '-' + Date.now();
}

function generateExcerpt(content) {
    const text = content.replace(/<[^>]*>/g, '');
    return text.substring(0, 180) + '...';
}

async function createArticle(topic, categoryId, categoryName) {
    try {
        console.log(`\nüìù Creating article: "${topic}"`);
        
        // Generate content using OpenRouter
        const content = await generateArticleContent(topic, categoryName);
        
        const article = {
            title: topic,
            slug: generateSlug(topic),
            content: content,
            excerpt: generateExcerpt(content),
            category_id: categoryId,
            featured_image: '/images/all/1.jpg',
            author: 'AI Writer',
            status: 'published',
            view_count: Math.floor(Math.random() * 500) + 50,
            published_at: new Date().toISOString(),
            created_at: new Date().toISOString()
        };
        
        const { data, error } = await supabase
            .from('articles')
            .insert([article])
            .select();
        
        if (error) {
            console.error('‚ùå Error saving article:', error.message);
            return false;
        }
        
        console.log(`‚úÖ Article created: "${topic}" (ID: ${data[0].id})`);
        return true;
    } catch (error) {
        console.error('‚ùå Error creating article:', error.message);
        return false;
    }
}

async function generateAllArticles() {
    console.log('üöÄ Starting article generation...\n');
    console.log('=' .repeat(50));
    
    // Get categories first
    const { data: categories, error: catError } = await supabase
        .from('categories')
        .select('*')
        .order('id');
    
    if (catError) {
        console.error('‚ùå Error fetching categories:', catError.message);
        return;
    }
    
    console.log(`üìÇ Found ${categories.length} categories\n`);
    
    let successCount = 0;
    let failCount = 0;
    
    // Generate articles for each category
    for (const category of categories) {
        const topics = articleTopics[category.id];
        
        if (!topics) {
            console.log(`‚ö†Ô∏è  No topics defined for category: ${category.name}`);
            continue;
        }
        
        console.log(`\nüìÇ Category: ${category.name} (ID: ${category.id})`);
        console.log('-'.repeat(50));
        
        for (const topic of topics) {
            const success = await createArticle(topic, category.id, category.name);
            if (success) {
                successCount++;
            } else {
                failCount++;
            }
            
            // Small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    console.log('\n' + '='.repeat(50));
    console.log('üìä SUMMARY');
    console.log('='.repeat(50));
    console.log(`‚úÖ Successfully created: ${successCount} articles`);
    console.log(`‚ùå Failed: ${failCount} articles`);
    console.log(`üìù Total: ${successCount + failCount} articles`);
    console.log('='.repeat(50));
    console.log('\nüéâ Article generation complete!');
    console.log('üåê Check your blog at: http://localhost:3000/index.html\n');
}

// Run the script
generateAllArticles()
    .then(() => process.exit(0))
    .catch(error => {
        console.error('‚ùå Fatal error:', error);
        process.exit(1);
    });

